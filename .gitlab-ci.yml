stages:
  - build
  - deploy

variables:
  IMAGE: "registry.git.commtool.org:443/schuelerj/mapmaker_fasthtml:latest"
  DOCKER_BUILDKIT: 1

# optional: CI runner tags
.default:
  tags:
    - dockerD

docker-build:
  stage: build
  extends: .default
  image: docker:24.0.2 # Docker-in-Docker Image
  services:
    - docker:24.0.2-dind
  script:
    - echo "Logging into container registry"
    - echo "$CI_JOB_TOKEN" | docker login $CI_REGISTRY -u gitlab-ci-token --password-stdin
    - echo "Building image $IMAGE"
    - docker build -t $IMAGE .
    - echo "Pushing image $IMAGE"
    - docker push $IMAGE
  only:
    - main
    - merge_requests
# deploy:
#   stage: deploy
#   extends: .default
#   script:
#     - echo "Deploy step placeholder"
#     # Hier kannst du ggf. deinen docker-compose deploy Befehl einfÃ¼gen
#   only:
#     - main

# Deploy auf Prod
# deploy-prod:
#   stage: deploy
#   extends: .default
#   image: alpine:latest
#   before_script:
#     # SSH-Client installieren
#     - apk add --no-cache openssh-client
#     # SSH-Key aus GitLab Secret hinterlegen
#     - mkdir -p ~/.ssh
#     - echo "$PROD_SSH_KEY" > ~/.ssh/id_rsa
#     - chmod 600 ~/.ssh/id_rsa
#     # Optional: Hostname alias definieren
#     - echo -e "Host prod\n  HostName <PROD_SERVER_IP_OR_DOMAIN>\n  User <SSH_USER>\n  IdentityFile ~/.ssh/id_rsa" > ~/.ssh/config
#   script:
#     - echo "Deploying Docker image on prod server"
#     - ssh -o StrictHostKeyChecking=no prod "cd ~/combined/test_mapmaker && dc down && dc pull && dc up -d"
#   only:
#     - main
