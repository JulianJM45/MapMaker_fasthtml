stages:
  - build
  - deploy

variables:
  IMAGE: "registry.git.commtool.org:443/schuelerj/mapmaker_fasthtml:latest"
  DOCKER_BUILDKIT: 1

# optional: CI runner tags
.default:
  tags:
    - dockerD

docker-build:
  stage: build
  extends: .default
  image: docker:24.0.2 # Docker-in-Docker Image
  services:
    - docker:24.0.2-dind
  script:
    - echo "Logging into container registry"
    - echo "$CI_JOB_TOKEN" | docker login $CI_REGISTRY -u gitlab-ci-token --password-stdin
    - echo "Building image $IMAGE"
    - docker build -t $IMAGE .
    - echo "Pushing image $IMAGE"
    - docker push $IMAGE
  only:
    - main
    - merge_requests

deploy-prod:
  stage: deploy
  extends: .default
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
  script:
    - echo "Deploying image to prod server"
    - ssh -o StrictHostKeyChecking=no prod "cd ~/combined/test_mapmaker && dc down && dc pull && dc up -d"
  only:
    - main
